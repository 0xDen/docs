
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://fobnail.3mdeb.com/debugging/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>Debugging nRF52840 dongle - Fobnail Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#debugging-nrf52840-dongle" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Fobnail Documentation" class="md-header__button md-logo" aria-label="Fobnail Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Fobnail Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Debugging nRF52840 dongle
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Fobnail Documentation" class="md-nav__button md-logo" aria-label="Fobnail Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Fobnail Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Intro
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../description/" class="md-nav__link">
        Project description
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        Fobnail architecture
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../flashing_samples/" class="md-nav__link">
        Flashing sample applications
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../environment/" class="md-nav__link">
        Environment setup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../resources/" class="md-nav__link">
        Resources
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connection" class="md-nav__link">
    Connection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#programming-and-recovery" class="md-nav__link">
    Programming and recovery
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging" class="md-nav__link">
    Debugging
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="debugging-nrf52840-dongle">Debugging nRF52840 dongle</h1>
<p>It is possible to debug the nRF82540 dongle wit ha JLink debugger. The dongle
contains a depopulated JLink header and a 10 pads for connecting the ribbon
needle connector or a straight ribbon.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>For this purpose we will need:</p>
<ul>
<li>nRF82540 Development Kit (PCA10056)</li>
<li><a href="https://www.tag-connect.com/product/tc2050-idc-nl-050-all">Needle 10-pin cable with ribbon 1.27mm pitch</a>
  for use with Development Kit</li>
</ul>
<p>One may use a JLink pro with a suitable adapter to the correct ribbon cable
with needle connector. However JLink PRO is very expensive (25x more expensive
than development kit).</p>
<p>Also if using a development kit, it only uses a voltage o 3V to program and
debug applications so we need to slightly modify the dongle for development kit
use.</p>
<ol>
<li>Firstly cut the SB2 and solder SB1. This will allow to use VDD_OUT pin as a
   power source.
   <img alt="" src="../images/configuring_external_power_source.png" /></li>
<li>Solder jumper wires (male-end) to the following pads (color convention may
   be different, but in the whole documentation we will use the following color
   convention):
   <img alt="" src="../images/nRF52840_dongle_wires.png" /> Description:</li>
<li>black wire - male-male jumper wire (GND)</li>
<li>violet - male-male jumper wire (VDD_OUT)</li>
</ol>
<blockquote>
<p>IMPORTANT! Do not connect the dongle to USB when SB2 is cut and SB1 is soldered.</p>
</blockquote>
<h2 id="connection">Connection</h2>
<p>How does it work? The nRF82540 development kit can program external chips via
the <code>debug out</code> connector. In order to program the nRF52840 dongle:</p>
<p><img alt="" src="../images/nrf52840_dk.png" /></p>
<ol>
<li>Connect Needle 10-pin cable with ribbon 1.27mm pitch to the debug out
   header. The ribbon has an edging which fits into the header only in one
   orientation.</li>
<li>Connect black write from the dongle to one of the red GND pin on the female
   header on the left (according to picture). Connect the violet wire from the
   dongle to the red VDD pin on the female header on the left (according to
   picture). The development kit will source VDD power 3V which is suitable for
   the programming with the development kit. The dongle automatically uses 5V
   on the VDD and VBUS' (connected to EXT_GND_DETECT) which will damage the dev
   kit. Also the dev kit selects which chip to program based on the power
   supply of the target chip:</li>
<li>if VDD is present on the debug out connector then the external chip is
     programmed</li>
<li>otherwise the dev kit's on-board chip is programmed
   So in order to program the dongle with the dev kit we have to supply
   compatible voltage from the dev kit to the dongle. That is why the dongle
   required modifications to source power from VDD_OUT pin.</li>
<li>Connect the needle 10-pin cable with ribbon 1.27mm pitch to the JLink
   connector on the dongle (see picture below, marked in red). The needle has 3
   positions pins which will fit in a single orientation only.
   <img alt="" src="../images/configuring_external_power_source.png" /></li>
</ol>
<h2 id="programming-and-recovery">Programming and recovery</h2>
<p>Now that we have prepared correct connections between dev kit and the dongle we
may proceed with flashing. For example if we erase whole chip along with UICR
which sets the voltage regulator on the dongle we will not be able to program
it via dev kit unless we do the modifications described before. The nRF52840
chip on the dongle hardware is configured in high voltage mode. This uses REG0
to lower the chip supply voltage (VDD), and the default value is 1.8 V,
configured by the REGOUT0 register in UICR. This is too low to be used with the
on-board programmer on the nRF52840 DK, so erasing or programming with a
firmware that does not configure the regulator for a higher VDD will leave it
in a state where it cannot be re-programmed from a dev kit.</p>
<p>To avoid problems if you are using a debugger without level shifter (such as a
nRF52840 DK):</p>
<ul>
<li>Avoid erasing the UICR of the chip (i.e. do not do a full chip erase).</li>
<li>If you must erase the UICR, make sure that you do not reset the board until
  after you have programmed either REGOUT0 directly or firmware that sets it.</li>
<li>Alternatively, modify the dongle as explained under External regulated source
  and supply the dongle directly from the nRF52 DK (assuming it is used as a
  debugger).</li>
</ul>
<p>In our case we have done the modifications and will recover the original
bootloader:</p>
<ol>
<li><code>wget https://devzone.nordicsemi.com/cfs-file/__key/communityserver-blogs-components-weblogfiles/00-00-00-00-13/pca10059_5F00_bootloader.zip</code></li>
<li><code>unzip pca10059_5F00_bootloader.zip</code></li>
<li>Copy the file
   <code>graviton_bootloader_mbr_v1.0.1-[nRF5_SDK_15.0.1-1.alpha_f76d012].hex</code> into
   the directory mounted inside thee fobnail-sdk container.</li>
<li>Grab the dongle with needle and hold it tight so that the needle will
   connect with the pins.</li>
<li>Execute <code>nrfjprog -f NRF52 --program graviton_bootloader_mbr_v1.0.1-[nRF5_SDK_15.0.1-1.alpha_f76d012].hex --chiperase</code></li>
<li>Disconnect the needle and the wires from dongle and devkit.</li>
<li>Connect violet and green wire.</li>
<li>Plug the dongle into computer USB port while holding reset button. Check if
   the LED diode is blinking red which indicates teh original bootloader mode
   has been entered. Also the <code>dmesg</code> that the USB Nordic bootloader has been
   detected.</li>
</ol>
<h2 id="debugging">Debugging</h2>
<p>There is an incompatibility in the debug header of the dongle and dev kit:</p>
<p><img alt="Dongle debug header" src="../images/dongle_debug_header.png" />
<img alt="Development kit debug out header" src="../images/debug_out_header.png" /></p>
<p>The 5th pin of debug out header (second picture) is connected the the dev kit's
ground, while 5th pin on the JLink header on the dongle is connected to VBUS'
which is 5V when the dongle is connected to the USB. This makes the debugging
of the dongle effectively impossible when the dongle is connected to the USB
port. However, when it is supplied with power via VDD_OUT, it is possible to
debug it, but it will be impossible to debug USB connection. The right way to
debug the dongle without modifications is to use the P1 header on the dongle
which matches 100% the pinout of debug out header of the dev kit. Note that the
modifications are still needed if the UICR is removed to supply the VDD of the
dongle with 3V from dev kit.</p>
<p>In order to connect to the P1 header one would need a SMT 2x5 pin header pitch
1.27mm, the same as used on the debug out header on the dev kit. Here you may
find big pictures of such header:
https://blog.adafruit.com/2019/01/17/new-product-mini-swd-0-05-pitch-connector-10-pin-smt-box-header/</p>
<p>Until we do not need to debug USB connection, we may use a blinky sample as a
reference program to be debugged. Refer to <a href="../flashing_samples/">Flashing sample applications</a>
how to build the samples. Now we will try to flash them with the needle
connector instead of USB DFU. Inside the fobnail SDK container execute:</p>
<ol>
<li><code>make clean</code></li>
<li><code>make mcuboot_demo</code></li>
<li><code>make blinky_demo</code></li>
<li>Ensure the chip is erased (ti simulate a fault and that we lost UICR) so
   connect the black and violet wires to the dev kit's GND and VDD, grab the
   dongle with needle and hold it tight so that the needle will connect with
   the pins. Execute <code>make erase</code>.</li>
<li>Flash the nRF52840 dongle while holding the needle:
   <div class="highlight"><pre><span></span><code>nrfjprog -f NRF52 --program graviton_bootloader_mbr_v1.0.1-\[nRF5_SDK_15.0.1-1.alpha_f76d012\].hex 
</code></pre></div></li>
<li>Unplug and plug the violet wire to dev kit's VDD. This will initiate a reset
   of the dongle (the Jlink header does not expose reset signal, only P1 header
   has reset signal).</li>
<li>Notice the red LED should start blinking indicating Nordic's bootloader
   mode. It has entered the bootloader mode automatically because USB
   connection has not been detected thus the rest switch was not needed.</li>
<li>Solder SB2 and desolder SB1. Unplug black and violet wires. Unplug the
   needle connector. Black wire floating safely.</li>
<li>Plug the dongle into USB and flash the samples using DFU as instructed in
   <a href="../flashing_samples/">Flashing sample applications</a>.</li>
</ol>
<p>Since the Nordic's bootloader is stuck when not connected to USB, and we cannot
use dev kit to debug when dongle is connected to USB, the guide below presents
how to debug a blinky sample on the nRF82540 chip present on the dev kit.
Although it will apply to the dongle as well if you solder the P1 header and
connect the straight ribbon cable to debug out and P1 header. If you have a
straight ribbon cable and P1 header soldered you may use the dongle instead.</p>
<ol>
<li>Disconnect the dongle from the dev kit.</li>
<li><code>west build -b nrf52840dk_nrf52840 -d build/blinky zephyr/samples/basic/blinky</code></li>
<li><code>nrfjprog --eraseall -f nrf52</code></li>
<li><code>nrfjprog -f nrf52 --program build/blinky/zephyr/zephyr.hex</code></li>
<li>Now the green LED1 on the dev kit should start blinking.</li>
<li>Launch JLink GDB server inside the container:
   <div class="highlight"><pre><span></span><code>JLinkGDBServerCLExe -select USB -device nRF52840_xxAA -endian little \
    -if SWD -speed 4000 -ir -noLocalhostOnly &amp;
</code></pre></div></li>
<li>Connect with GDB to the nRF52840 chip on the dev kit:
   <div class="highlight"><pre><span></span><code>gdb
(gdb) file build/blinky/zephyr/zephyr.elf
(gdb) target remote localhost:2331
</code></pre></div></li>
<li>Execute the following commands in GDB to start debugging [TBD]</li>
</ol>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.b1047164.min.js"></script>
      
    
  </body>
</html>